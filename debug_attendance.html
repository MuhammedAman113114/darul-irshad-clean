<!DOCTYPE html>
<html>
<head>
    <title>Debug Attendance</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1e1e1e; color: #d4d4d4; }
        button { padding: 10px 20px; margin: 5px; background: #007acc; color: white; border: none; cursor: pointer; }
        button:hover { background: #005a9e; }
        .danger { background: #d32f2f; }
        .danger:hover { background: #b71c1c; }
        pre { background: #2d2d2d; padding: 15px; border-radius: 4px; overflow-x: auto; }
        h3 { color: #4ec9b0; }
    </style>
</head>
<body>
    <h1>üîç Attendance Debug Tool</h1>
    
    <button onclick="checkLocks()">Check Locks</button>
    <button onclick="clearLocks()">Clear All Locks</button>
    <button onclick="checkAttendance()">Check Attendance Data</button>
    <button class="danger" onclick="clearAll()">Clear Everything</button>
    
    <div id="output"></div>

    <script>
        function output(html) {
            document.getElementById('output').innerHTML = html;
        }

        function checkLocks() {
            const locks = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('attendance_lock_')) {
                    try {
                        locks[key] = JSON.parse(localStorage.getItem(key));
                    } catch {
                        locks[key] = localStorage.getItem(key);
                    }
                }
            }
            output(`<h3>Attendance Locks (${Object.keys(locks).length})</h3><pre>${JSON.stringify(locks, null, 2)}</pre>`);
        }

        function clearLocks() {
            let count = 0;
            const keys = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('attendance_lock_')) {
                    keys.push(key);
                }
            }
            keys.forEach(key => {
                localStorage.removeItem(key);
                count++;
            });
            output(`<h3>‚úÖ Cleared ${count} locks</h3>`);
            setTimeout(checkLocks, 100);
        }

        function checkAttendance() {
            const attendance = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('attendance_') && !key.startsWith('attendance_lock_')) {
                    try {
                        const data = JSON.parse(localStorage.getItem(key));
                        attendance[key] = {
                            date: data.date,
                            period: data.period,
                            students: data.students?.length || 0,
                            savedAt: data.metadata?.savedAt
                        };
                    } catch {
                        attendance[key] = 'Invalid JSON';
                    }
                }
            }
            output(`<h3>Attendance Records (${Object.keys(attendance).length})</h3><pre>${JSON.stringify(attendance, null, 2)}</pre>`);
        }

        function clearAll() {
            if (!confirm('Clear ALL attendance data and locks?')) return;
            let count = 0;
            const keys = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('attendance_')) {
                    keys.push(key);
                }
            }
            keys.forEach(key => {
                localStorage.removeItem(key);
                count++;
            });
            output(`<h3>‚úÖ Cleared ${count} items</h3>`);
        }

        // Auto-run on load
        checkLocks();
    </script>
</body>
</html>
