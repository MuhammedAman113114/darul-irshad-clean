# üö® Missed Section Auto-Detection System

## Problem Statement
Build an intelligent system that automatically detects missed attendance periods and moves them to a "Missed Section" queue for makeup classes.

## üéØ Core Requirements

### Business Logic
```
IF period exists in timetable 
AND no holiday declared 
AND attendance not taken by 12:00 AM next day
THEN move to missed section

ELSE ignore (no false positives)
```

### Example Scenario
```
üìÖ July 23, 2025 (Today)
üïê Timetable shows: Period 1, Period 2, Period 3
‚úÖ Period 1: Attendance taken
‚úÖ Period 2: Attendance taken  
‚ùå Period 3: No attendance taken

‚è∞ Wait until 12:00 AM July 24
üîÑ Auto-check: Period 3 ‚Üí Move to Missed Section
```

## üóÑÔ∏è Database Design

```sql
-- Timetable structure
CREATE TABLE timetable (
    id INT PRIMARY KEY,
    class_id INT,
    section VARCHAR(10),
    day_of_week ENUM('monday','tuesday','wednesday','thursday','friday','saturday'),
    period_number INT,
    subject_id INT,
    start_time TIME,
    end_time TIME,
    is_active BOOLEAN DEFAULT 1,
    created_at TIMESTAMP,
    INDEX idx_class_day (class_id, day_of_week)
);

-- Attendance tracking
CREATE TABLE attendance (
    id INT PRIMARY KEY,
    student_id INT,
    class_id INT,
    section VARCHAR(10),
    subject_id INT,
    date DATE,
    period_number INT,
    status ENUM('Present', 'Absent', 'Late'),
    taken_at TIMESTAMP,
    is_makeup BOOLEAN DEFAULT 0,
    original_missed_date DATE NULL,
    INDEX idx_attendance_check (class_id, section, subject_id, date, period_number)
);

-- Missed sections queue
CREATE TABLE missed_sections (
    id INT PRIMARY KEY,
    class_id INT,
    section VARCHAR(10),
    subject_id INT,
    missed_date DATE,
    period_number INT,
    detected_at TIMESTAMP,
    reason VARCHAR(255) DEFAULT 'Attendance not taken',
    is_completed BOOLEAN DEFAULT 0,
    completed_at TIMESTAMP NULL,
    makeup_date DATE NULL,
    INDEX idx_pending_missed (is_completed, class_id)
);

-- Holiday calendar
CREATE TABLE holidays (
    id INT PRIMARY KEY,
    date DATE UNIQUE,
    description VARCHAR(255),
    is_active BOOLEAN DEFAULT 1,
    INDEX idx_holiday_date (date, is_active)
);
```

## üîÑ Core System Implementation

### 1. Daily Missed Section Detection (Cron Job)

```python
# File: missed_section_detector.py
import schedule
import time
from datetime import datetime, timedelta
from database import execute_query, get_connection

class MissedSectionDetector:
    
    def __init__(self):
        self.today = datetime.now().date()
        self.yesterday = self.today - timedelta(days=1)
        self.yesterday_weekday = self.yesterday.strftime('%A').lower()
    
    def run_daily_detection(self):
        """Main function - runs at 12:00 AM daily"""
        print(f"üîç Starting missed section detection for {self.yesterday}")
        
        # Step 1: Skip if yesterday was holiday
        if self.is_holiday(self.yesterday):
            print(f"‚è© Skipping {self.yesterday} - Holiday declared")
            return
        
        # Step 2: Get all scheduled periods for yesterday
        scheduled_periods = self.get_scheduled_periods()
        print(f"üìã Found {len(scheduled_periods)} scheduled periods")
        
        # Step 3: Check each period for attendance
        missed_count = 0
        for period in scheduled_periods:
            if not self.is_attendance_taken(period):
                self.create_missed_section(period)
                missed_count += 1
                print(f"‚ùå Missed: {period['class_name']} - {period['subject_name']} - Period {period['period_number']}")
        
        print(f"‚úÖ Detection complete. {missed_count} periods moved to missed section")
    
    def is_holiday(self, date):
        """Check if date is declared holiday"""
        query = """
        SELECT COUNT(*) as count 
        FROM holidays 
        WHERE date = %s AND is_active = 1
        """
        result = execute_query(query, [date])
        return result[0]['count'] > 0
    
    def get_scheduled_periods(self):
        """Get all periods that should have happened yesterday"""
        query = """
        SELECT 
            t.class_id, t.section, t.subject_id, t.period_number,
            c.class_name, s.subject_name, t.start_time, t.end_time
        FROM timetable t
        JOIN classes c ON t.class_id = c.id  
        JOIN subjects s ON t.subject_id = s.id
        WHERE t.day_of_week = %s 
        AND t.is_active = 1
        ORDER BY t.class_id, t.period_number
        """
        return execute_query(query, [self.yesterday_weekday])
    
    def is_attendance_taken(self, period):
        """Check if attendance was taken for specific period"""
        query = """
        SELECT COUNT(DISTINCT student_id) as student_count
        FROM attendance 
        WHERE class_id = %s 
        AND section = %s 
        AND subject_id = %s 
        AND date = %s 
        AND period_number = %s
        """
        result = execute_query(query, [
            period['class_id'],
            period['section'], 
            period['subject_id'],
            self.yesterday,
            period['period_number']
        ])
        
        # If any student attendance recorded = attendance was taken
        return result[0]['student_count'] > 0
    
    def create_missed_section(self, period):
        """Add period to missed sections table"""
        query = """
        INSERT INTO missed_sections 
        (class_id, section, subject_id, missed_date, period_number, detected_at, reason)
        VALUES (%s, %s, %s, %s, %s, NOW(), 'Attendance not taken')
        """
        execute_query(query, [
            period['class_id'],
            period['section'],
            period['subject_id'], 
            self.yesterday,
            period['period_number']
        ])

# Schedule the job
detector = MissedSectionDetector()

# Run at 12:00 AM every day
schedule.every().day.at("00:00").do(detector.run_daily_detection)

# Keep the script running
while True:
    schedule.run_pending()
    time.sleep(60)  # Check every minute
```

### 2. Missed Section Management Interface

```python
# File: missed_section_manager.py
class MissedSectionManager:
    
    def get_pending_missed_sections(self, filters=None):
        """Get all pending missed sections with filters"""
        base_query = """
        SELECT 
            ms.id, ms.class_id, ms.section, ms.missed_date, ms.period_number,
            c.class_name, s.subject_name, ms.detected_at,
            CONCAT(c.class_name, COALESCE(CONCAT(' - ', ms.section), '')) as full_class_name,
            DATEDIFF(NOW(), ms.detected_at) as days_pending
        FROM missed_sections ms
        JOIN classes c ON ms.class_id = c.id
        JOIN subjects s ON ms.subject_id = s.id  
        WHERE ms.is_completed = 0
        """
        
        params = []
        
        # Apply filters
        if filters:
            if filters.get('class_id'):
                base_query += " AND ms.class_id = %s"
                params.append(filters['class_id'])
            
            if filters.get('teacher_id'):
                base_query += """ AND ms.subject_id IN (
                    SELECT subject_id FROM teacher_subjects 
                    WHERE teacher_id = %s
                )"""
                params.append(filters['teacher_id'])
            
            if filters.get('date_from'):
                base_query += " AND ms.missed_date >= %s"
                params.append(filters['date_from'])
        
        base_query += " ORDER BY ms.missed_date DESC, ms.period_number"
        
        return execute_query(base_query, params)
    
    def take_makeup_attendance(self, missed_section_id, attendance_data):
        """Take attendance for missed section"""
        try:
            # Get missed section details
            missed_section = self.get_missed_section_details(missed_section_id)
            
            if not missed_section:
                return {"success": False, "error": "Missed section not found"}
            
            # Insert attendance records with makeup flag
            for student_data in attendance_data:
                self.insert_makeup_attendance(missed_section, student_data)
            
            # Mark missed section as completed
            self.mark_completed(missed_section_id)
            
            return {"success": True, "message": "Makeup attendance recorded successfully"}
            
        except Exception as e:
            return {"success": False, "error": str(e)}
    
    def insert_makeup_attendance(self, missed_section, student_data):
        """Insert makeup attendance record"""
        query = """
        INSERT INTO attendance 
        (student_id, class_id, section, subject_id, date, period_number, 
         status, taken_at, is_makeup, original_missed_date)
        VALUES (%s, %s, %s, %s, %s, %s, %s, NOW(), 1, %s)
        """
        execute_query(query, [
            student_data['student_id'],
            missed_section['class_id'],
            missed_section['section'],
            missed_section['subject_id'],
            datetime.now().date(),  # Today's date for makeup
            missed_section['period_number'],
            student_data['status'],
            missed_section['missed_date']  # Original missed date
        ])
    
    def mark_completed(self, missed_section_id):
        """Mark missed section as completed"""
        query = """
        UPDATE missed_sections 
        SET is_completed = 1, completed_at = NOW(), makeup_date = %s
        WHERE id = %s
        """
        execute_query(query, [datetime.now().date(), missed_section_id])
    
    def get_missed_section_details(self, missed_section_id):
        """Get specific missed section details"""
        query = """
        SELECT ms.*, c.class_name, s.subject_name
        FROM missed_sections ms
        JOIN classes c ON ms.class_id = c.id
        JOIN subjects s ON ms.subject_id = s.id
        WHERE ms.id = %s
        """
        result = execute_query(query, [missed_section_id])
        return result[0] if result else None
```

### 3. Timetable Sync Handler

```python
# File: timetable_sync.py
class TimetableSyncHandler:
    
    def handle_timetable_change(self, change_type, old_data, new_data):
        """Handle timetable modifications and sync missed sections"""
        
        if change_type == 'PERIOD_DELETED':
            self.handle_period_deletion(old_data)
        elif change_type == 'PERIOD_ADDED':
            self.handle_period_addition(new_data)
        elif change_type == 'PERIOD_MODIFIED':
            self.handle_period_modification(old_data, new_data)
    
    def handle_period_deletion(self, deleted_period):
        """When period is deleted from timetable"""
        # Remove any pending missed sections for this period
        query = """
        DELETE FROM missed_sections 
        WHERE class_id = %s 
        AND section = %s 
        AND subject_id = %s 
        AND period_number = %s
        AND is_completed = 0
        """
        execute_query(query, [
            deleted_period['class_id'],
            deleted_period['section'],
            deleted_period['subject_id'],
            deleted_period['period_number']
        ])
        
        print(f"üóëÔ∏è Cleaned up missed sections for deleted period")
    
    def handle_period_addition(self, new_period):
        """When new period is added to timetable"""
        # Check if this period was missed in past dates
        self.retroactive_missed_section_check(new_period)
    
    def retroactive_missed_section_check(self, period):
        """Check past dates for newly added period"""
        # Look back 30 days for missed instances
        end_date = datetime.now().date()
        start_date = end_date - timedelta(days=30)
        
        current_date = start_date
        while current_date < end_date:
            if current_date.strftime('%A').lower() == period['day_of_week']:
                if not self.is_holiday(current_date):
                    if not self.attendance_exists(period, current_date):
                        self.create_retroactive_missed_section(period, current_date)
            current_date += timedelta(days=1)
```

## üéØ Implementation Checklist

### Phase 1: Core Detection System
- [ ] Set up database tables with proper indexes
- [ ] Create MissedSectionDetector class
- [ ] Implement daily cron job (12:00 AM trigger)
- [ ] Add holiday validation logic
- [ ] Test with sample timetable data

### Phase 2: Management Interface  
- [ ] Build MissedSectionManager class
- [ ] Create teacher dashboard for pending missed sections
- [ ] Implement makeup attendance interface
- [ ] Add completion tracking and audit trail
- [ ] Test makeup attendance workflow

### Phase 3: Timetable Integration
- [ ] Create TimetableSyncHandler class
- [ ] Handle period addition/deletion events
- [ ] Implement retroactive checking
- [ ] Add conflict resolution logic
- [ ] Test timetable change scenarios

### Phase 4: Edge Cases & Optimization
- [ ] Handle partial attendance scenarios  
- [ ] Add bulk operations support
- [ ] Implement notification system
- [ ] Optimize database queries with indexes
- [ ] Add comprehensive error handling

## üö® Critical Business Rules

```yaml
Detection Rules:
  - Only scheduled periods count (timetable must exist)
  - Respect holiday calendar (no false positives)
  - 12:00 AM cutoff for previous day
  - Any student attendance = period was conducted

Makeup Rules:
  - Link makeup to original missed date
  - Maintain complete audit trail
  - Allow multiple makeup attempts
  - Track completion status

Sync Rules:
  - Auto-sync on timetable changes
  - Retroactive checking for new periods
  - Clean up on period deletion
  - Preserve historical data
```

## üîß Deployment Setup

```bash
# Cron job setup
crontab -e

# Add this line for daily execution at 12:00 AM
0 0 * * * /usr/bin/python3 /path/to/missed_section_detector.py >> /var/log/missed_sections.log 2>&1

# Database indexes for performance
CREATE INDEX idx_timetable_lookup ON timetable(class_id, day_of_week, is_active);
CREATE INDEX idx_attendance_check ON attendance(class_id, section, subject_id, date, period_number);
CREATE INDEX idx_missed_pending ON missed_sections(is_completed, detected_at);
```

## üìä Success Metrics

- ‚úÖ Zero false positive missed sections
- ‚úÖ 100% detection accuracy for legitimate missed periods  
- ‚úÖ Sub-second response time for missed section queries
- ‚úÖ Automatic sync with timetable changes
- ‚úÖ Complete audit trail for all makeup attendance

---

**üöÄ Start with the core detection system and gradually add management features. Focus on bulletproof logic before building UI components.**